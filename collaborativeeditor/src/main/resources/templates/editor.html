<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Collaborative Editor</title>
    <!-- Add Quill Theme CSS -->
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <style>
      .editor-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      #editor-wrapper {
        height: 400px;
        margin: 10px 0;
        border: 1px solid #ccc;
      }
      .ql-editor {
        font-family: Arial, sans-serif;
        font-size: 14px;
        min-height: 350px;
      }
      .info-text {
        color: #666;
        margin: 10px 0;
      }
      .user-section {
        margin-bottom: 20px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
      .active-users {
        margin-top: 10px;
        padding: 10px;
        background-color: #e8f5e9;
        border-radius: 4px;
      }
      .active-users ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .active-users li {
        padding: 5px 10px;
        margin: 5px 0;
        background-color: #fff;
        border-radius: 3px;
        display: flex;
        align-items: center;
      }
      .user-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #4caf50;
        margin-right: 8px;
      }
      .copy-button {
        padding: 5px 10px;
        margin-left: 10px;
        cursor: pointer;
      }
      .status-indicator {
        height: 10px;
        width: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
      }
      .status-connected {
        background-color: #4caf50;
      }
      .status-disconnected {
        background-color: #f44336;
      }
    </style>
  </head>
  <body>
    <div class="editor-container">
      <h1>Collaborative Document Editor</h1>

      <!-- User Section -->
      <div class="user-section">
        <label for="username">Your Name:</label>
        <input
          type="text"
          id="username"
          name="username"
          value="Anonymous User"
        />
        <div class="connection-status">
          Status: <span class="status-indicator"></span>
          <span id="connection-text">Connecting...</span>
        </div>
      </div>

      <!-- Document Info Section -->
      <div class="info-text">
        <label for="document-id">Document ID:</label>
        <span
          id="document-id"
          th:text="${document != null ? document.id : 'Not Available'}"
          >ID</span
        >
        <button class="copy-button" onclick="copyDocumentUrl()">
          Copy URL to Share
        </button>
      </div>

      <!-- Active Users Section -->
      <div class="active-users">
        <h3>Currently Editing:</h3>
        <ul id="active-users-list"></ul>
      </div>

      <!-- Quill Editor Section -->
      <label for="editor-wrapper">Document Content:</label>
      <div id="editor-wrapper"></div>

      <!-- Last Editor Info -->
      <div class="info-text">
        <label for="last-editor">Last edited by:</label>
        <span
          id="last-editor"
          th:text="${document != null ? document.lastEditor : 'No edits yet'}"
          >Editor Name</span
        >
      </div>
    </div>

    <!-- Add Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script th:inline="javascript">
      const documentData = /*[[${document}]]*/ null;
      const documentId = documentData ? documentData.id : null;
      let activeUsers = new Set();
      let quill;
      let isReceivingUpdate = false;

      if (!documentId) {
        console.error("No document ID found");
        window.location.href = "/documents/new";
      }

      // Initialize Quill editor
      quill = new Quill("#editor-wrapper", {
        theme: "snow",
        modules: {
          toolbar: [
            ["bold", "italic", "underline"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["clean"],
          ],
        },
        placeholder: "Start typing here...",
      });

      // Disable editor until connection is established
      quill.disable();

      // Set initial content
      if (documentData && documentData.content) {
        try {
          const content = JSON.parse(documentData.content);
          quill.setContents(content);
        } catch (e) {
          quill.setText(documentData.content || "");
        }
      }

      const lastEditor = document.getElementById("last-editor");
      const usernameInput = document.getElementById("username");
      const activeUsersList = document.getElementById("active-users-list");
      const statusIndicator = document.querySelector(".status-indicator");
      const connectionText = document.getElementById("connection-text");
      let socket;
      let lastUpdateTime = 0;
      const UPDATE_DEBOUNCE = 100; // Minimum time between updates in ms

      function updateConnectionStatus(connected) {
        statusIndicator.className =
          "status-indicator " +
          (connected ? "status-connected" : "status-disconnected");
        connectionText.textContent = connected ? "Connected" : "Disconnected";

        if (connected) {
          quill.enable();
          sendUserUpdate("join");
        } else {
          quill.disable();
        }
      }

      function updateActiveUsers(users) {
        activeUsersList.innerHTML = "";
        if (Array.isArray(users)) {
          users.forEach((username) => {
            const li = document.createElement("li");
            const indicator = document.createElement("span");
            indicator.className = "user-indicator";
            const nameSpan = document.createElement("span");
            nameSpan.textContent = username;
            li.appendChild(indicator);
            li.appendChild(nameSpan);
            activeUsersList.appendChild(li);
          });
        }
      }

      function copyDocumentUrl() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
          alert(
            "URL copied to clipboard! Share this with others to collaborate."
          );
        });
      }

      function connectToServer() {
        socket = new WebSocket(`ws://${window.location.host}/document-ws`);

        socket.onopen = () => {
          console.log("Connected to server");
          updateConnectionStatus(true);
        };

        socket.onmessage = (event) => {
          try {
            const response = JSON.parse(event.data);
            if (response.documentId === documentId) {
              if (response.type === "user_update") {
                // Handle user list updates
                if (response.users) {
                  updateActiveUsers(Array.from(response.users));
                }
              } else {
                // Handle document content updates
                isReceivingUpdate = true;
                try {
                  const content = JSON.parse(response.content);
                  const currentContents = quill.getContents();
                  if (
                    JSON.stringify(currentContents) !== JSON.stringify(content)
                  ) {
                    quill.setContents(content);
                  }
                } catch (e) {
                  console.error("Error applying update:", e);
                }
                lastEditor.textContent = response.editor;
                isReceivingUpdate = false;
              }
            }
          } catch (error) {
            console.error("Error processing message:", error);
          }
        };

        socket.onclose = () => {
          console.log("Connection closed. Reconnecting...");
          updateConnectionStatus(false);
          setTimeout(connectToServer, 1000);
        };

        socket.onerror = (error) => {
          console.error("WebSocket error:", error);
          updateConnectionStatus(false);
        };
      }

      function sendUserUpdate(action) {
        if (socket && socket.readyState === WebSocket.OPEN) {
          const update = {
            type: "user_update",
            documentId: documentId,
            username: usernameInput.value,
            action: action,
          };
          socket.send(JSON.stringify(update));
        }
      }

      let editTimeout;
      quill.on("text-change", function (delta, oldDelta, source) {
        if (isReceivingUpdate || source !== "user") {
          return;
        }

        const now = Date.now();
        if (now - lastUpdateTime < UPDATE_DEBOUNCE) {
          clearTimeout(editTimeout);
        }

        editTimeout = setTimeout(() => {
          if (!socket || socket.readyState !== WebSocket.OPEN) {
            console.warn("Socket not connected. Attempting to reconnect...");
            connectToServer();
            return;
          }

          const contents = quill.getContents();
          const edit = {
            documentId: documentId,
            content: JSON.stringify(contents),
            editor: usernameInput.value,
            timestamp: now,
          };

          try {
            socket.send(JSON.stringify(edit));
            lastUpdateTime = now;
          } catch (error) {
            console.error("Error sending edit:", error);
          }
        }, UPDATE_DEBOUNCE);
      });

      usernameInput.addEventListener("change", () => {
        sendUserUpdate("join");
      });

      // Handle page unload
      window.addEventListener("beforeunload", () => {
        sendUserUpdate("leave");
      });

      // Initial connection
      connectToServer();
    </script>
  </body>
</html>
